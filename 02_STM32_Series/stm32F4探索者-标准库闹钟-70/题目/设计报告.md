# STM32F407 综合实验设计报告

---

## 目录

1. 设计目的
2. 系统概述
3. 实现原理说明
   3.1 RTC实时时钟原理
   3.2 PWM呼吸灯原理
   3.3 输入捕获原理
   3.4 闹钟中断原理
4. 程序设计
   4.1 系统总体架构
   4.2 功能模块划分
   4.3 各模块功能说明
   4.4 模块间关系
   4.5 程序流程图
5. 硬件电路说明
   5.1 引脚分配
   5.2 硬件连接
6. 程序调试与测试
   6.1 编译环境
   6.2 调试方法
   6.3 测试结果
7. 总结
8. 附录：程序清单

---

## 1. 设计目的

本设计基于STM32F407探索者V3开发板，实现一个综合性嵌入式应用系统，主要目的包括：

1. 掌握STM32F407的RTC实时时钟配置与使用
2. 掌握定时器PWM输出控制LED亮度
3. 掌握定时器输入捕获测量脉冲宽度
4. 掌握中断机制及闹钟功能实现
5. 掌握按键检测与人机交互设计
6. 综合运用上述知识完成一个实用的嵌入式系统

---

## 2. 系统概述

本系统实现以下功能：

| 功能模块 | 功能描述 |
|----------|----------|
| LCD显示 | 显示用户信息（学院/专业/学号/姓名）和实时时间 |
| RTC时钟 | 24小时制实时时钟，格式：YYYY-MM-DD Week HH:MM:SS |
| 双闹钟 | 闹钟A/B独立设置，触发时蜂鸣器报警3秒 |
| PWM呼吸灯 | LED0亮度渐变效果，可调节速度 |
| 输入捕获 | 测量PWM信号高电平时间，精度1us |
| 按键控制 | KEY0加快呼吸速度，KEY1减慢呼吸速度 |
| 独立看门狗 | IWDG超时1秒，TIM3中断500ms喂狗，防止死机 |
| 串口调试 | USMART调试接口，可通过串口设置时间和闹钟 |

---

## 3. 实现原理说明

### 3.1 RTC实时时钟原理

STM32F407内置RTC模块，使用32.768KHz外部低速晶振(LSE)作为时钟源，具有以下特点：

- **日历功能**：年、月、日、星期、时、分、秒
- **闹钟功能**：支持闹钟A和闹钟B，可按星期设置
- **唤醒功能**：周期性唤醒中断
- **备份域**：RTC寄存器在VBAT供电时保持

**时钟配置**：
```
LSE = 32.768KHz
异步预分频 = 127 (32768/128 = 256Hz)
同步预分频 = 255 (256/256 = 1Hz)
```

### 3.2 PWM呼吸灯原理

利用TIM14定时器的PWM模式控制LED亮度：

- **定时器**：TIM14 (APB1, 84MHz)
- **通道**：CH1，对应PF9 (LED0)
- **PWM模式**：模式1，向上计数，CNT<CCR时输出有效电平
- **频率**：84MHz / 84 / 500 = 2KHz
- **占空比**：CCR1/ARR = 0~100%

**呼吸效果实现**：
```
周期性改变CCR值 (0→500→0)
步长决定速度：10=慢速，50=快速
```

### 3.3 输入捕获原理

利用TIM5定时器捕获PWM信号高电平时间：

- **定时器**：TIM5 (APB1, 84MHz, 32位计数器)
- **通道**：CH1，对应PA0
- **计数频率**：84MHz / 84 = 1MHz (1us分辨率)

**捕获过程**：
```
1. 检测上升沿 → 清零计数器，切换为下降沿捕获
2. 检测下降沿 → 读取计数值(即高电平时间)，切换为上升沿捕获
3. 处理溢出计数，计算总时长
```

### 3.4 闹钟中断原理

RTC闹钟通过EXTI17线触发中断：

```
RTC闹钟 → EXTI17 → NVIC → RTC_Alarm_IRQHandler
```

**中断处理**：
- 检测ISR寄存器第8/9位判断是闹钟A还是B
- 设置全局标志g_alarm_flag
- 主循环检测标志，控制蜂鸣器和LCD提示

---

## 4. 程序设计

### 4.1 系统总体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        main.c (主程序)                       │
├─────────────────────────────────────────────────────────────┤
│  初始化模块  │  显示模块  │  控制模块  │  中断服务模块       │
├──────────────┼────────────┼────────────┼────────────────────┤
│ sys_init     │ lcd_show   │ key_scan   │ RTC_Alarm_IRQHandler│
│ led_init     │ rtc_get    │ beep_ctrl  │ TIM3_IRQHandler    │
│ beep_init    │            │ pwm_update │ TIM5_IRQHandler    │
│ key_init     │            │            │                    │
│ lcd_init     │            │            │                    │
│ rtc_init     │            │            │                    │
│ timer_init   │            │            │                    │
└──────────────┴────────────┴────────────┴────────────────────┘
```

### 4.2 功能模块划分

| 模块名称 | 源文件 | 功能描述 |
|----------|--------|----------|
| 系统时钟 | sys.c | 配置168MHz系统时钟 |
| 延时函数 | delay.c | 提供ms/us级延时 |
| 串口通信 | usart.c | USART1初始化和printf重定向 |
| LED驱动 | led.c | LED初始化和控制 |
| 蜂鸣器驱动 | beep.c | 蜂鸣器初始化和控制 |
| 按键驱动 | key.c | 按键初始化和扫描 |
| LCD驱动 | lcd.c | LCD初始化和显示函数 |
| RTC驱动 | rtc.c | RTC初始化、时间读写、闹钟设置 |
| 定时器驱动 | gtim.c | TIM3/TIM5/TIM14配置 |
| 看门狗驱动 | wdg.c | IWDG初始化和喂狗 |
| USMART | usmart.c | 串口调试组件 |
| 主程序 | main.c | 系统初始化和主循环 |

### 4.3 各模块功能说明

#### 4.3.1 显示模块
- `display_user_info()` - 显示学院/专业/学号/姓名
- `display_rtc_time()` - 显示日期和时间

#### 4.3.2 闹钟模块
- `rtc_set_alarma()` - 设置闹钟A
- `rtc_set_alarmb()` - 设置闹钟B
- `alarm_check_and_handle()` - 闹钟检测和处理

#### 4.3.3 呼吸灯模块
- `gtim_timx_pwm_chy_init()` - PWM初始化
- `breathing_led_update()` - 更新PWM占空比

#### 4.3.4 输入捕获模块
- `gtim_timx_cap_chy_init()` - 输入捕获初始化
- 中断中处理捕获逻辑

#### 4.3.5 按键控制模块
- `key_init()` - 按键初始化
- `key_scan_and_handle()` - 按键扫描和处理

### 4.4 模块间关系

```
            ┌──────────────┐
            │   main.c     │
            └──────┬───────┘
                   │
    ┌──────────────┼──────────────┐
    │              │              │
    ▼              ▼              ▼
┌───────┐    ┌───────────┐   ┌────────┐
│ 显示  │    │   控制    │   │  中断  │
│ 模块  │    │   模块    │   │  服务  │
├───────┤    ├───────────┤   ├────────┤
│lcd.c  │◄───│ key.c     │   │gtim.c  │
│rtc.c  │    │ beep.c    │   │rtc.c   │
└───────┘    │ gtim.c    │   └────┬───┘
             └─────┬─────┘        │
                   │              │
                   ▼              │
             ┌───────────┐        │
             │  BSP驱动  │◄───────┘
             │  (底层)   │
             └───────────┘
```

### 4.5 程序流程图

```
                    ┌─────────────┐
                    │   系统上电   │
                    └──────┬──────┘
                           ▼
                    ┌─────────────┐
                    │ 时钟配置    │
                    │ (168MHz)    │
                    └──────┬──────┘
                           ▼
              ┌────────────────────────┐
              │     外设初始化         │
              │ LED/BEEP/KEY/LCD/RTC   │
              │ TIM3/TIM14/TIM5        │
              └───────────┬────────────┘
                          ▼
              ┌────────────────────────┐
              │   LCD显示用户信息      │
              └───────────┬────────────┘
                          ▼
              ┌────────────────────────┐
          ┌──►│      主循环开始        │
          │   └───────────┬────────────┘
          │               ▼
          │   ┌────────────────────────┐
          │   │   每100ms更新RTC显示   │
          │   └───────────┬────────────┘
          │               ▼
          │   ┌────────────────────────┐
          │   │ 检查输入捕获完成标志   │
          │   │   是→显示高电平时间    │
          │   └───────────┬────────────┘
          │               ▼
          │   ┌────────────────────────┐
          │   │   检查闹钟触发标志     │
          │   │ 是→蜂鸣器+LCD提示      │
          │   └───────────┬────────────┘
          │               ▼
          │   ┌────────────────────────┐
          │   │   每20ms更新呼吸灯     │
          │   │   改变PWM占空比        │
          │   └───────────┬────────────┘
          │               ▼
          │   ┌────────────────────────┐
          │   │   扫描按键状态         │
          │   │ KEY0→快速 KEY1→慢速   │
          │   └───────────┬────────────┘
          │               ▼
          │   ┌────────────────────────┐
          │   │      延时10ms          │
          │   └───────────┬────────────┘
          │               │
          └───────────────┘
```

---

## 5. 硬件电路说明

### 5.1 引脚分配

| 引脚 | 功能 | 说明 |
|------|------|------|
| PF9 | TIM14_CH1 | PWM输出，连接LED0(红) |
| PF10 | GPIO | LED1(绿)，状态指示 |
| PA0 | TIM5_CH1 | 输入捕获 |
| PF8 | GPIO | 蜂鸣器控制 |
| PE3 | GPIO | KEY1按键 |
| PE4 | GPIO | KEY0按键 |
| PA9 | USART1_TX | 串口发送 |
| PA10 | USART1_RX | 串口接收 |
| PC14/PC15 | OSC32 | 32.768KHz晶振 |

### 5.2 硬件连接

**★ 重要：使用杜邦线连接 PF9 (LED0) → PA0 (WK_UP)，形成PWM闭环采集**

---

## 6. 程序调试与测试

### 6.1 编译环境

- IDE: Keil MDK-ARM V5.06
- 编译器: ARM Compiler V5.06 update 7
- 芯片包: STM32F4xx_DFP

### 6.2 调试方法

1. **编译检查**：确保0 Error, 0 Warning
2. **串口监控**：连接串口助手(115200)观察调试信息
3. **功能测试**：逐项验证各功能模块

### 6.3 测试结果

| 测试项目 | 预期结果 | 测试方法 |
|----------|----------|----------|
| LCD显示 | 显示用户信息和时间 | 目视检查 |
| RTC走时 | 时间每秒更新 | 观察10秒 |
| 呼吸灯 | LED0亮度渐变 | 目视检查 |
| 按键控制 | KEY0加快/KEY1减慢 | 按键测试 |
| 输入捕获 | 串口输出高电平时间 | 连接PF9-PA0 |
| 闹钟功能 | 蜂鸣器响+LCD提示 | 设置闹钟 |
| 看门狗功能 | 系统不复位，LED1每500ms闪烁 | 观察LED1和系统运行 |

---

## 7. 总结

本设计成功实现了基于STM32F407的综合嵌入式系统，涵盖了RTC时钟、PWM控制、输入捕获、中断处理、人机交互等多个知识点。通过本次设计，深入理解了：

1. STM32定时器的多种工作模式（计时、PWM、捕获）
2. RTC模块的配置和闹钟中断机制
3. 模块化程序设计思想
4. 嵌入式系统调试方法

---

## 8. 附录：程序清单

### 主程序 main.c
（见源代码文件）

### RTC驱动修改部分
- 新增 `rtc_set_alarmb()` 函数
- 修改 `RTC_Alarm_IRQHandler()` 支持双闹钟

### USMART配置
- 新增 `rtc_set_alarmb` 命令接口

---

**报告完成日期**：2025年12月26日
